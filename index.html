<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat with OpenAI Assistant</title>
<style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; }
    .chat-container { max-width: 600px; margin: 20px auto; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
    .chat-header { background-color: #007bff; color: #ffffff; padding: 10px; text-align: center; }
    .chat-body { background-color: #ffffff; padding: 10px; height: 400px; overflow-y: auto; }
    .chat-footer { background-color: #f0f2f5; padding: 10px; }
    .message { margin-bottom: 15px; }
    .user-message { text-align: right; }
    .user-message p { background-color: #007bff; color: #ffffff; padding: 10px; display: inline-block; border-radius: 20px; }
    .assistant-message p { background-color: #e9ecef; padding: 10px; display: inline-block; border-radius: 20px; }
</style>
</head>
<body>

<div class="chat-container">
    <div class="chat-header">
        <h2>OpenAI Assistant Chat</h2>
    </div>
    <div class="chat-body" id="chatBody">
        <!-- Messages will be added here dynamically -->
    </div>
    <div class="chat-footer">
        <form id="queryForm">
            <input type="text" id="question" name="question" placeholder="Type a message..." required style="width: 80%;">
            <input type="submit" value="Send" style="width: 18%;">
        </form>
    </div>
</div>

<script>
  // Retrieve an existing thread_id if available
  let threadId = localStorage.getItem("threadId");

  document.addEventListener('DOMContentLoaded', function() {
    SetWyattCookies(); // Call this function as soon as the DOM is fully loaded
    });

  document.getElementById("queryForm").onsubmit = async function(event) {
    
    event.preventDefault();
    let question = document.getElementById("question").value;

    // Add the user's question to the chat interface immediately
    addMessageToChat("user", question); // Ensure this is called with "user" to display the user's message

    const conversationUuid = getCookieValue('BDT_ChatBot_Conversation_UUID');
    const userUuid = getCookieValue('BDT_ChatBot_User_UUID');
    console.log("conversationUuid:", conversationUuid);
    console.log("userUuid:", userUuid);


    // Prepare the request data; note that thread_id will be added if available
    let requestData = {question: question, conversation_uuid: conversationUuid, user_id: userUuid, thread_id: threadId};
    console.log("Sending data to server:", requestData);

    try {
        let response = await fetch('https://openai-assistant-mnf3hilwwq-uk.a.run.app/query/', { // What I used for Docker.  For local -Open with Live Server- http://127.0.0.1:8002/query/ https://openai-assistant-mnf3hilwwq-uk.a.run.app/query/)
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        let jsonResponse = await response.json();
        addMessageToChat("assistant", jsonResponse.response); // This displays the assistant's response

        if (jsonResponse.thread_id) {
            threadId = jsonResponse.thread_id;
            localStorage.setItem("threadId", threadId);
        }

    } catch (error) {
        console.error('Error:', error);
        addMessageToChat("assistant", "Error: Could not fetch the response.");
    }
    document.getElementById("question").value = ""; // Clear input field after sending
};



  function addMessageToChat(sender, message) {
      let chatBody = document.getElementById("chatBody");
      let messageDiv = document.createElement("div");
      messageDiv.classList.add("message");
      if (sender === "user") {
          messageDiv.classList.add("user-message");
          messageDiv.innerHTML = `<p>${message}</p>`;
      } else {
          messageDiv.classList.add("assistant-message");
          messageDiv.innerHTML = `<p>${message}</p>`;
      }
      chatBody.appendChild(messageDiv);
      chatBody.scrollTop = chatBody.scrollHeight; // Scroll to the bottom
  }


 // Cookie management functions added below
//  function SetWyattCookies(){
//     const hasBdtChatBotUserCookie = document.cookie.split('; ').find(row => row.startsWith('BDT_ChatBot_User_UUID' + '='));
//     if (!hasBdtChatBotUserCookie) {
//         setCookieIfNotExists('BDT_ChatBot_User_UUID', uuidv4(), 2); // Set for 2 years
//     }
//     const hasBdtChatBotConversationCookie = document.cookie.split('; ').find(row => row.startsWith('BDT_ChatBot_Conversation_UUID' + '='));
//     if (!hasBdtChatBotConversationCookie) {
//         setCookieIfNotExists('BDT_ChatBot_Conversation_UUID', uuidv4(), 2); // Set for 2 years
//     }
//   }

function SetWyattCookies() {
    const hasBdtChatBotUserCookie = document.cookie.split('; ').find(row => row.startsWith('BDT_ChatBot_User_UUID' + '='));
    if (!hasBdtChatBotUserCookie) {
        const userUuid = uuidv4(); 
        setCookie('BDT_ChatBot_User_UUID', userUuid, 2); // Set for 2 years
    }
    
    const hasBdtChatBotConversationCookie = document.cookie.split('; ').find(row => row.startsWith('BDT_ChatBot_Conversation_UUID' + '='));
    if (!hasBdtChatBotConversationCookie) {
        const conversationUuid = uuidv4();
        setCookie('BDT_ChatBot_Conversation_UUID', conversationUuid, 2); // Set for 2 years
    }
}

// Helper function to set cookies with attributes
function setCookie(cookieName, cookieValue, expiryYears) {
    const date = new Date();
    date.setFullYear(date.getFullYear() + expiryYears);
    document.cookie = `${cookieName}=${cookieValue}; expires=${date.toUTCString()}; path=/; SameSite=Lax; Secure`; 
}

  function uuidv4() {
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & (15 >> c / 4)).toString(16)
    );
  }

  function setCookieIfNotExists(cookieName, cookieValue, expiryYears) {
    if (!document.cookie.split('; ').find(row => row.startsWith(cookieName + '='))) {
        const date = new Date();
        date.setFullYear(date.getFullYear() + expiryYears);
        document.cookie = `${cookieName}=${cookieValue}; expires=${date.toUTCString()}; path=/`;
    }
  }

  function getCookieValue(cookieName) {
    const name = cookieName + "=";
    const decodedCookie = decodeURIComponent(document.cookie);
    const ca = decodedCookie.split(';');
    for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) === 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
  }

  function deleteCookie(cookieName) {
    const date = new Date();
    date.setTime(date.getTime() - (24 * 60 * 60 * 1000));
    document.cookie = `${cookieName}=; expires=${date.toUTCString()}; path=/`;
  }
</script>


</body>
</html>
